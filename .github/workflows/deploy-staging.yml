name: Deploy to Staging

on:
  workflow_dispatch:
    inputs:
      service:
        description: 'Service to deploy'
        required: true
        default: 'both'
        type: choice
        options:
        - frontend
        - backend
        - both
      environment:
        description: 'Environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - staging
        - production

jobs:
  deploy-frontend:
    if: ${{ github.event.inputs.service == 'frontend' || github.event.inputs.service == 'both' }}
    runs-on: [self-hosted, FE]
    environment: staging-frontend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup deployment directory
      run: |
        mkdir -p /opt/mars-app/frontend
        cp -r deployment/* /opt/mars-app/frontend/
        
    - name: Deploy frontend
      working-directory: /opt/mars-app/frontend
      run: |
        chmod +x deploy_frontend.sh
        ./deploy_frontend.sh ${{ github.event.inputs.environment }}
        
    - name: Verify deployment
      run: |
        docker ps | grep mars-frontend
        echo "Frontend deployment completed successfully"

  deploy-backend:
    if: ${{ github.event.inputs.service == 'backend' || github.event.inputs.service == 'both' }}
    runs-on: [self-hosted, BE]
    environment: staging-backend
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup deployment directory
      run: |
        mkdir -p /opt/mars-app/backend
        cp -r deployment/* /opt/mars-app/backend/
        
    - name: Deploy backend
      working-directory: /opt/mars-app/backend
      run: |
        chmod +x deploy_backend.sh
        ./deploy_backend.sh ${{ github.event.inputs.environment }}
        
    - name: Verify deployment
      run: |
        docker ps | grep mars-backend
        echo "Backend deployment completed successfully"